> 这篇文章我们来梳理一下 MySQL 数据库索引相关的知识。

![MindMap](assets/MySQL-Index.svg)

## 索引原理

我们都知道，创建索引是为了更快的查询数据，那为什么索引能加快查询效率呢？

因为索引的本质就是把无序的数据变成有序的查询。就好像给书加个目录一样，能够让我们快速找到需要的数据。其具体实现是
1. 把创建了索引的列的内容进行排序
2. 对排序结果生成倒排表
3. 在倒排表内容上拼上数据地址链
4. 查询的时候，先拿到倒排表内容，再取出数据地址链，从而拿到具体数据

## 一般实现索引的几种数据结构

根据数据场景的不同，会使用不同的数据结构来构造索引，常见的有：
1. Hash 索引
    - 把数据进行哈希算法获得哈希值，把这些哈希值放到一张哈希表中，哈希表放到内存
    - 基于哈希表实现，适合新增和等值查询，不是有序的，范围查询很慢，必须全表扫描

2. B+Tree 索引
    - MySQL InnoDB 存储引擎默认索引结构，可用于查找、分组和排序
    - 多叉树，相比较于二叉平衡树降低了树高，查询和更新复杂度都是 O(log(N))
    - B+Tree核心特点：非叶子结点不存数据，叶子结点存数据并通过链表有序链接

3. Full-Text 索引
    - 大量文件检索时，需要使用全文索引，因为它的速度是 like 的 N 倍

4. R-Tree 索引
    - 空间数据索引会从所有维度来索引数据，主要用于地理数据存储

5. 有序数组/跳表 索引
    - 如果使用有序数组结构来实现索引，点查情况是 O(1)，范围查询是 O(log(N)) ，因为可以用二分查找，
      整体查询效率都不错，但在更新数据时，需要有序挪动后面所有的元素，成本较高。所以有序数组索引只适用于静态数据

6. LSM-Tree 索引

## 不同存储引擎的索引模型

1. InnoDB 
    - 支持完整的事务
    - 四个标准的隔离级别
    - 聚簇索引保存了数据，较少磁盘I/O，提高查询性能
    - 支持在线热备
    - 支持外键

2. MyISAM 
    - 不支持事务
    - 不支持行锁，只支持表锁（读取时对所有需要读到的表加共享锁；写入时对表加排他锁）
    - 不支持外键
    - 设计简单，数据以紧密格式存储，适合少量只读数据存储
    - 支持压缩表，和空间数据索引

## 最左前缀原则

- 在执行查询过程中，不需要索引的全部定义，只需要满足最左前缀，就可以利用索引来加速。
- 最左前缀可以是联合索引的最左N个字段，也可以是字符串索引的最左M个字符。
- 遇到范围查询就会停止匹配，后续可能会走全索引扫描或range范围查询。
- 现代的查询优化器能够保证查询条件的字段顺序和联合索引的顺序不一致也能正确匹配到索引。

## 索引下推

- 索引下推是 MySQL5.6 引入的特性，指在索引遍历的过程中，在符合最左匹配原则情况下，对索引中包含的字段先进行判断，直接过滤掉不满足条件的记录，减少回表次数。

## 索引可能失效的场景

- where 语句中有范围查询，则右边的语句会索引失效
- where 语句中使用函数
- where 条件中有 or 语句，只有 or 条件中的每个列都有索引才会使用索引
- 跨表 join 操作中，只有主键和外键的数据类型相同时才能使用索引
- 如果列类型是字符串，一定要在条件中将数据使用引号引用起来，否则不使用索引
- 如果 MySQL 查询引擎估算使用全表扫描要比使用索引快，则不使用索引
- 如果数据列中的值很单一，比如true/false，0/1这种，没有必要建立索引
